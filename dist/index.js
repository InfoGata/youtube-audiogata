class x extends Error{response;request;options;constructor(e,s,n){const o=e.status||e.status===0?e.status:"",r=e.statusText||"",a=`${o} ${r}`.trim(),i=a?`status code ${a}`:"an unknown error";super(`Request failed with ${i}: ${s.method} ${s.url}`),this.name="HTTPError",this.response=e,this.request=s,this.options=n}}class q extends Error{request;constructor(e){super(`Request timed out: ${e.method} ${e.url}`),this.name="TimeoutError",this.request=e}}const m=t=>t!==null&&typeof t=="object",g=(...t)=>{for(const e of t)if((!m(e)||Array.isArray(e))&&e!==void 0)throw new TypeError("The `options` argument must be an object");return S({},...t)},j=(t={},e={})=>{const s=new globalThis.Headers(t),n=e instanceof globalThis.Headers,o=new globalThis.Headers(e);for(const[r,a]of o.entries())n&&a==="undefined"||a===void 0?s.delete(r):s.set(r,a);return s};function w(t,e,s){return Object.hasOwn(e,s)&&e[s]===void 0?[]:S(t[s]??[],e[s]??[])}const E=(t={},e={})=>({beforeRequest:w(t,e,"beforeRequest"),beforeRetry:w(t,e,"beforeRetry"),afterResponse:w(t,e,"afterResponse"),beforeError:w(t,e,"beforeError")}),S=(...t)=>{let e={},s={},n={};for(const o of t)if(Array.isArray(o))Array.isArray(e)||(e=[]),e=[...e,...o];else if(m(o)){for(let[r,a]of Object.entries(o))m(a)&&r in e&&(a=S(e[r],a)),e={...e,[r]:a};m(o.hooks)&&(n=E(n,o.hooks),e.hooks=n),m(o.headers)&&(s=j(s,o.headers),e.headers=s)}return e},Q=(()=>{let t=!1,e=!1;const s=typeof globalThis.ReadableStream=="function",n=typeof globalThis.Request=="function";if(s&&n)try{e=new globalThis.Request("https://empty.invalid",{body:new globalThis.ReadableStream,method:"POST",get duplex(){return t=!0,"half"}}).headers.has("Content-Type")}catch(o){if(o instanceof Error&&o.message==="unsupported BodyInit type")return!1;throw o}return t&&!e})(),Z=typeof globalThis.AbortController=="function",X=typeof globalThis.ReadableStream=="function",tt=typeof globalThis.FormData=="function",O=["get","post","put","patch","head","delete"],et={json:"application/json",text:"text/*",formData:"multipart/form-data",arrayBuffer:"*/*",blob:"*/*"},T=2147483647,M=Symbol("stop"),st={json:!0,parseJson:!0,stringifyJson:!0,searchParams:!0,prefixUrl:!0,retry:!0,timeout:!0,hooks:!0,throwHttpErrors:!0,onDownloadProgress:!0,fetch:!0},nt={method:!0,headers:!0,body:!0,mode:!0,credentials:!0,cache:!0,redirect:!0,referrer:!0,referrerPolicy:!0,integrity:!0,keepalive:!0,signal:!0,window:!0,dispatcher:!0,duplex:!0,priority:!0},ot=t=>O.includes(t)?t.toUpperCase():t,rt=["get","put","head","delete","options","trace"],at=[408,413,429,500,502,503,504],it=[413,429,503],C={limit:2,methods:rt,statusCodes:at,afterStatusCodes:it,maxRetryAfter:Number.POSITIVE_INFINITY,backoffLimit:Number.POSITIVE_INFINITY,delay:t=>.3*2**(t-1)*1e3},ct=(t={})=>{if(typeof t=="number")return{...C,limit:t};if(t.methods&&!Array.isArray(t.methods))throw new Error("retry.methods must be an array");if(t.statusCodes&&!Array.isArray(t.statusCodes))throw new Error("retry.statusCodes must be an array");return{...C,...t}};async function lt(t,e,s,n){return new Promise((o,r)=>{const a=setTimeout(()=>{s&&s.abort(),r(new q(t))},n.timeout);n.fetch(t,e).then(o).catch(r).then(()=>{clearTimeout(a)})})}async function ut(t,{signal:e}){return new Promise((s,n)=>{e&&(e.throwIfAborted(),e.addEventListener("abort",o,{once:!0}));function o(){clearTimeout(r),n(e.reason)}const r=setTimeout(()=>{e?.removeEventListener("abort",o),s()},t)})}const pt=(t,e)=>{const s={};for(const n in e)!(n in nt)&&!(n in st)&&!(n in t)&&(s[n]=e[n]);return s};class b{static create(e,s){const n=new b(e,s),o=async()=>{if(typeof n._options.timeout=="number"&&n._options.timeout>T)throw new RangeError(`The \`timeout\` option cannot be greater than ${T}`);await Promise.resolve();let i=await n._fetch();for(const l of n._options.hooks.afterResponse){const u=await l(n.request,n._options,n._decorateResponse(i.clone()));u instanceof globalThis.Response&&(i=u)}if(n._decorateResponse(i),!i.ok&&n._options.throwHttpErrors){let l=new x(i,n.request,n._options);for(const u of n._options.hooks.beforeError)l=await u(l);throw l}if(n._options.onDownloadProgress){if(typeof n._options.onDownloadProgress!="function")throw new TypeError("The `onDownloadProgress` option must be a function");if(!X)throw new Error("Streams are not supported in your environment. `ReadableStream` is missing.");return n._stream(i.clone(),n._options.onDownloadProgress)}return i},a=n._options.retry.methods.includes(n.request.method.toLowerCase())?n._retry(o):o();for(const[i,l]of Object.entries(et))a[i]=async()=>{n.request.headers.set("accept",n.request.headers.get("accept")||l);const u=await a;if(i==="json"){if(u.status===204||(await u.clone().arrayBuffer()).byteLength===0)return"";if(s.parseJson)return s.parseJson(await u.text())}return u[i]()};return a}request;abortController;_retryCount=0;_input;_options;constructor(e,s={}){if(this._input=e,this._options={...s,headers:j(this._input.headers,s.headers),hooks:E({beforeRequest:[],beforeRetry:[],beforeError:[],afterResponse:[]},s.hooks),method:ot(s.method??this._input.method??"GET"),prefixUrl:String(s.prefixUrl||""),retry:ct(s.retry),throwHttpErrors:s.throwHttpErrors!==!1,timeout:s.timeout??1e4,fetch:s.fetch??globalThis.fetch.bind(globalThis)},typeof this._input!="string"&&!(this._input instanceof URL||this._input instanceof globalThis.Request))throw new TypeError("`input` must be a string, URL, or Request");if(this._options.prefixUrl&&typeof this._input=="string"){if(this._input.startsWith("/"))throw new Error("`input` must not begin with a slash when using `prefixUrl`");this._options.prefixUrl.endsWith("/")||(this._options.prefixUrl+="/"),this._input=this._options.prefixUrl+this._input}if(Z){this.abortController=new globalThis.AbortController;const n=this._options.signal??this._input.signal;n?.aborted&&this.abortController.abort(n?.reason),n?.addEventListener("abort",()=>{this.abortController.abort(n.reason)}),this._options.signal=this.abortController.signal}if(Q&&(this._options.duplex="half"),this._options.json!==void 0&&(this._options.body=this._options.stringifyJson?.(this._options.json)??JSON.stringify(this._options.json),this._options.headers.set("content-type",this._options.headers.get("content-type")??"application/json")),this.request=new globalThis.Request(this._input,this._options),this._options.searchParams){const o="?"+(typeof this._options.searchParams=="string"?this._options.searchParams.replace(/^\?/,""):new URLSearchParams(this._options.searchParams).toString()),r=this.request.url.replace(/(?:\?.*?)?(?=#|$)/,o);(tt&&this._options.body instanceof globalThis.FormData||this._options.body instanceof URLSearchParams)&&!(this._options.headers&&this._options.headers["content-type"])&&this.request.headers.delete("content-type"),this.request=new globalThis.Request(new globalThis.Request(r,{...this.request}),this._options)}}_calculateRetryDelay(e){if(this._retryCount++,this._retryCount>this._options.retry.limit||e instanceof q)throw e;if(e instanceof x){if(!this._options.retry.statusCodes.includes(e.response.status))throw e;const n=e.response.headers.get("Retry-After")??e.response.headers.get("RateLimit-Reset")??e.response.headers.get("X-RateLimit-Reset")??e.response.headers.get("X-Rate-Limit-Reset");if(n&&this._options.retry.afterStatusCodes.includes(e.response.status)){let o=Number(n)*1e3;Number.isNaN(o)?o=Date.parse(n)-Date.now():o>=Date.parse("2024-01-01")&&(o-=Date.now());const r=this._options.retry.maxRetryAfter??o;return o<r?o:r}if(e.response.status===413)throw e}const s=this._options.retry.delay(this._retryCount);return Math.min(this._options.retry.backoffLimit,s)}_decorateResponse(e){return this._options.parseJson&&(e.json=async()=>this._options.parseJson(await e.text())),e}async _retry(e){try{return await e()}catch(s){const n=Math.min(this._calculateRetryDelay(s),T);if(this._retryCount<1)throw s;await ut(n,{signal:this._options.signal});for(const o of this._options.hooks.beforeRetry)if(await o({request:this.request,options:this._options,error:s,retryCount:this._retryCount})===M)return;return this._retry(e)}}async _fetch(){for(const n of this._options.hooks.beforeRequest){const o=await n(this.request,this._options);if(o instanceof Request){this.request=o;break}if(o instanceof Response)return o}const e=pt(this.request,this._options),s=this.request;return this.request=s.clone(),this._options.timeout===!1?this._options.fetch(s,e):lt(s,e,this.abortController,this._options)}_stream(e,s){const n=Number(e.headers.get("content-length"))||0;let o=0;return e.status===204?(s&&s({percent:1,totalBytes:n,transferredBytes:o},new Uint8Array),new globalThis.Response(null,{status:e.status,statusText:e.statusText,headers:e.headers})):new globalThis.Response(new globalThis.ReadableStream({async start(r){const a=e.body.getReader();s&&s({percent:0,transferredBytes:0,totalBytes:n},new Uint8Array);async function i(){const{done:l,value:u}=await a.read();if(l){r.close();return}if(s){o+=u.byteLength;const y=n===0?0:o/n;s({percent:y,transferredBytes:o,totalBytes:n},u)}r.enqueue(u),await i()}await i()}}),{status:e.status,statusText:e.statusText,headers:e.headers})}}/*! MIT License Â© Sindre Sorhus */const P=t=>{const e=(s,n)=>b.create(s,g(t,n));for(const s of O)e[s]=(n,o)=>b.create(n,g(t,o,{method:s}));return e.create=s=>P(g(s)),e.extend=s=>(typeof s=="function"&&(s=s(t??{})),P(g(t,s))),e.stop=M,e},p=P(),ht="https://oauth2.googleapis.com/token",c={get length(){try{return localStorage.length}catch{return 0}},clear:function(){try{localStorage.clear()}catch{}},getItem:function(t){try{return localStorage.getItem(t)}catch{return null}},removeItem:function(t){try{localStorage.removeItem(t)}catch{}},setItem:function(t,e){try{localStorage.setItem(t,e)}catch{}},key:function(t){try{return localStorage.key(t)}catch{return null}}};var h=(t=>(t.PipedInstances="piped-instances",t.PipedCurrentInstance="piped-current-instance",t.InvidiousInstances="invidious-instances",t.InvidiousCurrentInstance="invidious-current-instance",t))(h||{});const ft=t=>`https://www.youtube.com/watch?v=${t}`,dt="https://piped.kavin.rocks",yt=t=>({name:t.title,apiId:t.url.split("=").slice(-1)[0],images:[{url:t.thumbnail}],duration:t.duration}),v=async()=>{const e=await p.get("https://piped-instances.kavin.rocks/").json();return c.setItem(h.PipedInstances,JSON.stringify(e)),e},L=async()=>{const t=c.getItem(h.PipedInstances);let e=[];if(t)e=JSON.parse(t);else try{e=await v()}catch(n){return console.error(n),dt}const s=e[0].api_url;return c.setItem(h.PipedCurrentInstance,s),s},A=async()=>{const t=c.getItem(h.PipedInstances);return t?JSON.parse(t):await v()},d=async()=>{let t=c.getItem(h.PipedCurrentInstance);return t||(t=await L()),t};async function D(t,e=0){const s=await A();let n=await d();e>0&&e<s.length&&(n=s[e].api_url);try{const o=`${n}/streams/${t.apiId}`,r=1e4,a=new Promise((I,_)=>{setTimeout(()=>_(),r)}),i=p.get(o).json();return await Promise.race([i,a]),(await i).audioStreams.sort((I,_)=>_.bitrate-I.bitrate)[0].url}catch(o){const r=await A();if(e<r.length)return D(t,e+1);throw o}}const mt=async t=>{const s=`${await d()}/search?q=${t.query}&filter=videos`,n=await p.get(s).json(),o=n.items.filter(a=>a.type==="stream").map(a=>({name:a.title,apiId:a.url.split("=").slice(-1)[0],images:[{url:a.thumbnail}],duration:a.duration})),r={resultsPerPage:0,offset:0,nextPage:n.nextpage};return{items:o,pageInfo:r}},gt=async t=>{const s=`${await d()}/search?q=${t.query}&filter=playlists`,n=await p.get(s).json(),o=n.items.filter(a=>a.type==="playlist").map(a=>({name:a.name,apiId:a.url.split("=").slice(-1)[0],images:[{url:a.thumbnail}],tracks:[]})),r={resultsPerPage:0,offset:0,nextPage:n.nextpage};return{items:o,pageInfo:r}},wt=async t=>{const s=`${await d()}/playlists/${t.apiId}`,n=await p.get(s).json(),o=n.relatedStreams.map(yt),r={resultsPerPage:0,offset:0,nextPage:n.nextpage};return{items:o,pageInfo:r}},bt=async t=>{const s=`${await d()}/opensearch/suggestions?query=${t.query}`;return(await p.get(s).json())[1]},f="\\d+(?:[\\.,]\\d+)?",kt=`(${f}W)`,It=`(${f}Y)?(${f}M)?(${f}D)?`,_t=`T(${f}H)?(${f}M)?(${f}S)?`,Tt=`P(?:${kt}|${It}(?:${_t})?)`,Pt=["weeks","years","months","days","hours","minutes","seconds"],N=Object.freeze({years:0,months:0,weeks:0,days:0,hours:0,minutes:0,seconds:0}),Rt=new RegExp(Tt),St=t=>t.match(Rt).slice(1).reduce((e,s,n)=>(e[Pt[n]]=parseFloat(s)||0,e),{}),vt=(t,e)=>{t=Object.assign({},N,t);const s=e?e.getTime():Date.now(),n=new Date(s);return n.setFullYear(n.getFullYear()+t.years),n.setMonth(n.getMonth()+t.months),n.setDate(n.getDate()+t.days),n.setHours(n.getHours()+t.hours),n.setMinutes(n.getMinutes()+t.minutes),n.setMilliseconds(n.getMilliseconds()+t.seconds*1e3),n.setDate(n.getDate()+t.weeks*7),n},$t=(t,e)=>{t=Object.assign({},N,t);const s=e?e.getTime():Date.now(),n=new Date(s);return(vt(t,n).getTime()-n.getTime())/1e3},H="AIzaSyBYUoAxdG5OvUtnxH0HbBioIiF14Ce7RZ0",J=(t,e)=>{c.setItem("access_token",t),e&&c.setItem("refresh_token",e)},$=p.create({hooks:{beforeRequest:[t=>{const e=c.getItem("access_token");e&&t.headers.set("Authorization",`Bearer ${e}`)}],afterResponse:[async(t,e,s)=>{if(s.status===401){const n=await Ut();return t.headers.set("Authorization",`Bearer ${n}`),$(t,e)}}]}}),Ut=async()=>{const t=c.getItem("refresh_token");if(!t)return;const e=c.getItem("clientId"),s=c.getItem("clientSecret"),n=ht,o=new URLSearchParams;o.append("refresh_token",t),o.append("grant_type","refresh_token"),e&&s&&(o.append("client_id",e),o.append("client_secret",s));const r=await p.post(n,{headers:{"Content-Type":"application/x-www-form-urlencoded"},body:o}).json();if(r.access_token)return J(r.access_token),r.access_token},k=()=>c.getItem("apiKey");function xt(t){return(t.items||[]).map(s=>({apiId:s.id,name:s.snippet?.title||"",images:[{width:s.snippet?.thumbnails?.default?.width||0,url:s.snippet?.thumbnails?.default?.url||"",height:s.snippet?.thumbnails?.default?.height||0}],isUserPlaylist:!0}))}function K(t){return(t.items||[]).map(s=>({apiId:s.id,duration:$t(St(s.contentDetails?.duration||"0")),images:s.snippet?.thumbnails&&Object.values(s.snippet?.thumbnails).map(n=>({url:n.url||"",height:n.height||0,width:n.width||0})),name:s.snippet?.title||"",originalUrl:`https://www.youtube.com/watch?v=${s.id}`}))}async function Ct(){const t="https://www.googleapis.com/youtube/v3/videos",e=k()||H,s=`${t}?key=${e}&videoCategoryId=10&chart=mostPopular&part=snippet,contentDetails`,n=await p.get(s).json();return{tracks:{items:K(n)}}}async function B(t){const e=t.join(","),s="https://www.googleapis.com/youtube/v3/videos",n=k()||H,o=`${s}?key=${n}&part=snippet,contentDetails&id=${e}`,r=await p.get(o).json();return K(r)}async function At(t){let s=`https://www.googleapis.com/youtube/v3/playlistItems?part=contentDetails&maxResults=50&key=${k()}&playlistId=${t.apiId}`;t.isUserPlaylist&&(s+="&mine=true"),t.pageInfo&&(t.pageInfo.nextPage?s+=`&pageToken=${t.pageInfo.nextPage}`:t.pageInfo.prevPage&&(s+=`&pageToken=${t.pageInfo.prevPage}`));const o=await(t.isUserPlaylist?$:p).get(s).json(),r=o.items?.map(l=>l.contentDetails?.videoId).filter(l=>!!l)||[];return{items:await B(r),pageInfo:{totalResults:o.pageInfo?.totalResults||0,resultsPerPage:o.pageInfo?.resultsPerPage||0,offset:t.pageInfo?t.pageInfo.offset:0,nextPage:o.nextPageToken,prevPage:o.prevPageToken}}}async function Y(t){const s=`https://www.googleapis.com/youtube/v3/playlists?part=snippet,contentDetails&mine=true&key=${k()}`,n=await $.get(s).json();return{items:xt(n),pageInfo:{totalResults:n.pageInfo?.totalResults||0,resultsPerPage:n.pageInfo?.resultsPerPage||0,offset:t.pageInfo?t.pageInfo.offset:0,nextPage:n.nextPageToken,prevPage:n.prevPageToken}}}const qt=async()=>{let e=await p.get("https://api.invidious.io/instances.json").json();return e=e.filter(s=>!(s[0].includes(".onion")||s[0].includes(".i2p"))),e=e.filter(s=>s[1].cors),c.setItem(h.InvidiousInstances,JSON.stringify(e)),e},F=async()=>{const t=c.getItem(h.InvidiousInstances);let e=[];t?e=JSON.parse(t):e=await qt();const s=Math.floor(Math.random()*e.length),n=e[s][1].uri;return c.setItem(h.InvidiousCurrentInstance,n),n},jt=async()=>{let t=c.getItem(h.InvidiousCurrentInstance);return t||(t=await F()),t},Et=async t=>{let e=await jt();try{const s=`${e}${t}`;return await p.get(s).json()}catch{e=await F();const s=`${e}${t}`;return await p.get(s).json()}};async function Ot(t){const e=`/api/v1/videos/${t}`,s=await Et(e);return{name:s.title,apiId:t,duration:s.lengthSeconds,images:s.videoThumbnails,originalUrl:ft(t)}}const R=t=>{application.postUiMessage(t)},Mt=async()=>{const e=document.location.host.split(".");e.shift();const s=e.join("."),n=`${document.location.protocol}//${s}`,o=await application.getPluginId(),r=await application.getLocale(),a=await application.getPlaylistsInfo(),i=c.getItem("apiKey")??"",l=c.getItem("clientId")??"",u=c.getItem("clientSecret")??"",y=await d();R({type:"info",origin:n,pluginId:o,apiKey:i,clientId:l,clientSecret:u,instance:y,locale:r,playlists:a})},Lt=async t=>{const s=new URL(t).searchParams.get("list");if(s){const n=await W({apiId:s,isUserPlaylist:!1});return{...n.playlist,tracks:n.items}}throw new Error("Couldn't retreive playlist")},G=async t=>{const e=[];t.forEach(i=>{try{const l=/^(?:https?:\/\/)?(?:www\.)?(?:m\.)?(?:youtube\.com|youtu.be)\/(?:watch\?v=|embed\/|v\/)?([a-zA-Z0-9_-]+)(?:\S+)?$/,u=i.match(l);u&&e.push(u[1])}catch{}});const s=e.length,n=50;let o=0,r=n;const a=[];for(;o<s;){const i=e.slice(o,r),l=await B(i);a.push(...l),o+=n,r+=n}return a};application.onUiMessage=async t=>{switch(t.type){case"check-login":const e=c.getItem("access_token");e&&R({type:"login",accessToken:e}),await Mt();break;case"login":J(t.accessToken,t.refreshToken),application.onGetUserPlaylists=Y;break;case"logout":c.removeItem("access_token"),c.removeItem("refresh_token"),application.onGetUserPlaylists=void 0;break;case"set-keys":c.setItem("apiKey",t.apiKey),c.setItem("clientId",t.clientId),c.setItem("clientSecret",t.clientSecret),application.createNotification({message:"Api Keys saved!"});break;case"getinstnace":const s=await L();R({type:"sendinstance",instance:s});break;case"resolve-urls":const n=await G(t.trackUrls.split(`
`));await application.addTracksToPlaylist(t.playlistId,n),application.createNotification({message:"Success!"});break}};async function U(t){return mt(t)}async function Dt(t){return Ot(t.apiId)}async function z(t){return gt(t)}async function W(t){return t.isUserPlaylist?At(t):wt(t)}async function Nt(){return await Ct()}async function Ht(t){const e=U(t),s=z(t),[n,o]=await Promise.all([e,s]);return{tracks:n,playlists:o}}async function Jt(t){return await D(t)}async function Kt(t,e){const s=/^.*(youtu.be\/|list=)([^#\&\?]*).*/,n=/^(?:https?:\/\/)?(?:www\.)?(?:m\.)?(?:youtube\.com|youtu.be)\/(?:watch\?v=|embed\/|v\/)?([a-zA-Z0-9_-]+)(?:\S+)?$/;if(!s.test(t)&&!n.test(t))return!1;switch(e){case"playlist":return new URL(t).searchParams.has("list");case"track":return!0;default:return!1}}async function Bt(t){return bt(t)}application.onSearchAll=Ht;application.onSearchTracks=U;application.onSearchPlaylists=z;application.onGetTrackUrl=Jt;application.onGetPlaylistTracks=W;application.onGetTopItems=Nt;application.onGetTrack=Dt;application.onLookupPlaylistUrl=Lt;application.onLookupTrackUrls=G;application.onCanParseUrl=Kt;application.onGetSearchSuggestions=Bt;application.onLookupTrack=async t=>(await U({query:`${t.artistName} - ${t.trackName}`})).items[0];application.onDeepLinkMessage=async t=>{application.postUiMessage({type:"deeplink",url:t})};const V=t=>{localStorage.setItem("kb-color-mode",t)};application.onChangeTheme=async t=>{V(t)};const Yt=async()=>{const t=await application.getTheme();V(t),c.getItem("access_token")&&(application.onGetUserPlaylists=Y),await v()};Yt();
